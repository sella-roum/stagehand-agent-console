# Stagehand Agent Console

このプロジェクトは、AIを活用したブラウザ自動化フレームワーク [Stagehand](https://github.com/browserbase/stagehand) を基盤とし、**Google Gemini**, **Groq Cloud (Llama 3など)**, **OpenRouter** といった複数の大規模言語モデル（LLM）を組み合わせ、**対話型AIエージェント**を構築するサンプルプロジェクトです。

単にコマンドを実行するだけでなく、エージェントは自らの行動結果を**検証**し、エラー発生時にはその原因を**反省**して**自己修復**を試みます。マルチタブブラウジングや安全なファイルシステム連携など、複雑なタスクを遂行するための高度な機能を備えています。

実行時やエラー発生時には、インタラクティブなデバッグコンソールが起動し、AIエージェントの自律的な動作をリアルタイムで監視・介入できます。

## ✨ 主な機能

-   **マルチLLM対応:** `.env`ファイルを変更するだけで、Google Gemini, Groq, OpenRouter上の様々なモデルを簡単に切り替え可能。
-   **対話型デバッグコンソール:** エラー発生時に起動し、AIとの対話や手動介入を可能にします。
-   **プランナーAI (`agent`コマンド):** ユーザーが与えた高レベルなタスクをAIが分析し、具体的な実行ステップに分解して自律的に実行します。
-   **AIによる直接操作 (`act`, `observe`コマンド):** 単一の操作を自然言語でAIに指示し、即座に実行・確認できます。
-   **Playwrightネイティブ機能へのアクセス:** `inspect`コマンドでPlaywright Inspectorを、`eval`コマンドで任意のコードを実行でき、AIの操作とシームレスに連携できます。

## 💭 期待する結果（エージェント機能は、下記を実現できる可能性はありますが、安定性については検証中です）

-   **自律的なタスク計画と実行 (`agent`コマンド):**
    「競合他社の最新ニュースを調べてレポートを作成して」のような高レベルなタスクをAIが分析し、具体的な実行ステップに分解して自律的に実行します。

-   **自己修復・自己検証ループ (Self-Healing & Self-Verification):**
    エージェントは各ステップの実行後に、その操作が期待通りの結果をもたらしたかを**自己検証**します。失敗した場合は、エラーの原因を**自己分析（反省）**し、別の方法でタスクを達成するための新しい計画を自動的に立案します。これにより、動的なウェブサイトや予期せぬエラーに対して高い堅牢性を持ちます。

-   **マルチタブブラウジング:**
    複数のタブを同時に開き、タブを切り替えながら情報を収集・比較するなど、複雑なリサーチタスクを効率的に実行できます。

-   **安全なファイルシステム連携:**
    ブラウザで収集した情報をローカルファイルに書き出したり、ローカルの設定ファイルを読み込んでタスクに反映させたりできます。ファイル操作はプロジェクト内の`workspace`ディレクトリに限定され、実行前には必ずユーザーの許可を求めるため、安全性も確保されています。

-   **マルチLLM対応:**
    `.env`ファイルを変更するだけで、Google Gemini, Groq, OpenRouter上の様々なモデルを簡単に切り替え可能です。

-   **対話型デバッグコンソール:**
    エージェントの実行中やエラー発生時に起動し、AIとの対話や手動でのコード実行 (`eval`)、GUIでの要素調査 (`inspect`) を通じて、シームレスなデバッグと手動介入を可能にします。

## 🧠 エージェントの思考サイクル

このエージェントは、以下の思考サイクルに基づいて自律的に動作します。

```
[ 計画 (Plan) ] -> [ 実行 (Execute) ] -> [ 検証 (Verify) ]
      |                                        |
      | (成功)                                 | (失敗)
      |                                        v
      +--------------------------------> [ 反省 (Reflect) ]
      |                                        |
      +----------------------------------------+
      |
      v
[ 次の計画へ (Re-plan) ]
```

## 🛠️ セットアップ

### 1. プロジェクトのクローンと依存関係のインストール

まず、プロジェクトをクローンし、依存関係をインストールします。

```bash
# プロジェクトをクローン
git clone https://github.com/sella-roum/stagehand-agent-console.git
cd stagehand-agent-console

# 依存関係のインストール
npm install
# または
pnpm install
```

### 2. 環境変数の設定

AI機能を利用するには、各種サービスのAPIキーが必要です。

`.env.example` ファイルをコピーして `.env` ファイルを作成し、利用したいAIプロバイダのAPIキーを設定してください。

```bash
cp .env.example .env
```

次に、`.env` ファイルを開き、設定を編集します。**少なくとも1つのプロバイダのAPIキーを設定し、`LLM_PROVIDER`で使用するプロバイダを指定してください。**

```.env
# .env

# --- Google Gemini Settings ---
GOOGLE_API_KEY="YOUR_GOOGLE_API_KEY"
GEMINI_MODEL="gemini-2.5-flash"

# --- Groq Cloud Settings ---
GROQ_API_KEY="YOUR_GROQ_API_KEY"
GROQ_MODEL="compound-beta-mini"

# --- OpenRouter Settings ---
OPENROUTER_API_KEY="YOUR_OPENROUTER_API_KEY"
# モデル名は https://openrouter.ai/models で確認できます
OPENROUTER_MODEL=""

# --- Provider Selection ---
# 'google', 'groq', または 'openrouter' を指定
LLM_PROVIDER="google"
```

-   **`LLM_PROVIDER`**: `agent`コマンドが使用するAIプロバイダを`google`, `groq`, `openrouter`の中から選択します。
-   **`*_API_KEY`**: 利用するサービスのAPIキーを設定します。
-   **`*_MODEL`**: 各プロバイダで使用するモデル名を指定します。

## 🚀 実行方法

セットアップが完了したら、以下のコマンドでプロジェクトを起動します。

```bash
npm start
```

スクリプトが起動すると、対話型デバッグコンソールが開始されます。`workspace`ディレクトリは、ファイル操作コマンドが初めて実行される際に自動的に作成されます。

## 🤖 コンソールの使い方

コンソールが起動したら、`>` プロンプトに対して以下のコマンドを入力できます。

| コマンド | 説明 | 使用例 |
| :--- | :--- | :--- |
| **`act`** | AIに単一の具体的な操作を自然言語で指示します。 | `act:'Issues'タブをクリックして` |
| **`observe`** | 現在のページで操作可能な要素をAIに探させます。 | `observe:クリックできる全てのボタン` |
| **`agent`** | **[推奨]** AIにタスクを依頼し、自律的に計画・実行・自己修復させます。 | `agent:'https://www.stagehand.dev/' にアクセスして、ページ内にあるGithubリンクへアクセスし、そのリポジトリのスターの数を教えて` |
| **`inspect`** | Playwright Inspectorを起動し、GUIでページを調査します。 | `inspect` |
| **`eval`** | 任意のPlaywright/JavaScriptコードをその場で実行します。 | `eval:console.log(await page.title())` |
| **`goto`** | 指定したURLにページを移動させます。 | `goto:https://www.stagehand.dev/` |
| **`help`** | コマンドの一覧を表示します。 | `help` |
| **`exit`** | デバッグコンソールを終了します。 | `exit` |
